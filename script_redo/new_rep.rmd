---
title: "Stool 2.0"
author: "Amedeo Gagliardi, Antonio Francavilla, Beatrice Piaggeschi"
date: "26/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading libraries, message=FALSE, warning=FALSE, include=FALSE}
library(umap)
library(factoextra)
library(tidyverse)
library(kableExtra)
library(table1)
library(DESeq2)
library(plotly)
library(png)
library(pheatmap)
library(RColorBrewer)
library(ReportingTools)
library(ComplexHeatmap)
library(DT)
library(apeglm)
library(vsn)
library(hexbin)
```

```{r loading data and parameters, include=FALSE}
count.path <- c("C:/Users/amedeo/Desktop/R_Projects/stool/data_redo/ngs/merged_harmonized_converted.rds")
covar.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/clinical/merged_cleaned.rds") 
coldata <- readRDS(covar.path)
rawCount <- readRDS(count.path)
n_study <- table(coldata$study)
```

Last compiled on `r format(Sys.time(), '%d %B, %Y')`

Introduction

MicroRNAs are a class of small non-coding RNAs widely studied as potential biomarkers of different diseases and conditions. Indeed, they represent optimal biomarkers for several reasons including their stability and  detectability in different body fluids types. However, fewer studies investigated their expression according to covariates such as gender, age or smoke and alcohol consumption. 

Aim of this work was to investigate microRNA expression levels in healthy subjects in relation to age, sex, Body Mass Index (BMI), smoke, alcohol consumption and physical activity.

For this purpose, we analyzed Small RNA-seq data from `r length(rownames(coldata))` stool samples of  healthy subjects and ran differential expression analyses using DESeq2 package for R software.

Samples were healthy subjects from three different studies: Celiac (n= `r n_study[[1]]`), CRC (n= `r n_study[[2]]`) and VOV (n= `r n_study[[3]]`).


The table below describe the population used in this study.

```{r Table1, echo=FALSE}
coldata <- readRDS(covar.path)
df <- coldata

df <- df[,c("id_old","study","library","id_pat","age","sex","smoke", "alcool", "bmi_cat", "phys_act")]
colnames(df)[c(2,5,6,7,8,9,10)] <- c("Study","Age","Sex","Smoke","Alcohol", "BMI", "Phys_act")

levels(df$BMI) <- c("Underweight", "Normal", "Overweight", "Obese")
levels(df$Smoke) <- c("Non smoker", "Ex smoker", "Smoker")
levels(df$Study) <- c("Celiac", "CRC", "VOV")
df$Alcohol <- as.factor(df$Alcohol)
levels(df$Alcohol) <- c("Abstemious", "Light", "Heavy")
levels(df$Sex) <- c("Female", "Male")
levels(df$Phys_act) <- c("Inactive", "Moderately inactive", "Moderately active", "Active")

table1::units(df$Age) <- "Years"
table1::table1(~ Age + BMI + Smoke + Alcohol + Phys_act + Study | Sex, data = df, topclass = "Rtable1-zebra",
               footnote = "BMI: Underweight < 18, Normal 18-25, Overweight 25-30, Obese > 30 -- Alcohol: Abstemious 0 gr/day, Light 0.1-18.5 gr/day, Heavy > 18.5 gr/day -- Physical activity: Women - Inactive (<46.89); Mod. inactive (46.89-82.14); Mod. active (82.14-120.14); Active (> 120.14); Men - Inactive (< 34.00); Mod. inactive (34.00-56.76); Mod. active (56.76-87.06); Active (> 87.06)")

rm(df)

```

# Exploratory data anlyses and quality controls.

# PCA Analyses {.tabset .tabset-fade .tabset-pills}

We performed PCA analyses to assess technical covariates effects.

## Study {.tabset}

Patients from the celiac cohort show a different pattern from ones from CRC and VOV studies. Since 3 patients from the VOV study have the same pattern we further investigated to see if the differences are due to technical bias rather than the cohort of origin.

```{r PCA Study, echo=FALSE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

rawCount <- as.data.frame(readRDS(count.path))
coldata <- as.data.frame(readRDS(covar.path))

count.pca <- prcomp(log(rawCount+1))                     
tmp <- as.data.frame(count.pca$rotation[,c(1,2,3,4)])

colnames(tmp) <- c("PC1","PC2","PC3","PC4")

i <- intersect(rownames(tmp), rownames(coldata))
tmp <- tmp[i,]
coldata <- coldata[i,]

tmp[,"smoke"] <- coldata[match(rownames(tmp), rownames(coldata), nomatch=0),"smoke"]
tmp[,"age_cat"] <- coldata[match(rownames(tmp), rownames(coldata), nomatch=0),"age_cat"]
tmp[,"sex"] <- coldata[match(rownames(tmp), rownames(coldata), nomatch=0),"sex"]
tmp[,"study"] <- coldata[match(rownames(tmp), rownames(coldata), nomatch=0),"study"]
tmp[,"library"] <- coldata[match(rownames(tmp), rownames(coldata), nomatch=0),"library"]
tmp[,"pat"] <- coldata[match(rownames(tmp), rownames(coldata), nomatch=0), "id_pat"]

ggplot2::ggplot(data = tmp, ggplot2::aes(x=PC1, y=PC2)) +
  geom_point(aes(color=study, shape=pat))

fviz_eig(count.pca)

```


## Library {.tabset}

```{r VOV in CEL, include=FALSE}
xx <- which(coldata$library == "Library CEL stool 2" & coldata$study == "VOV")
yy <- rownames(coldata)[xx]
zz <- paste(yy, collapse = ", ")
```

The differences are due to the different libraries. `r zz` were sequenced in a Celiac library and separate with those samples in the PCA plot. So we decided to use the library covariate as adjustment in our models.

```{r PCA Library, echo=FALSE}
ggplot2::ggplot(data = tmp, ggplot2::aes(x=PC1, y=PC2)) +
  geom_point(ggplot2::aes(color=library))


```


## Condition {.tabset}

There are no technical differences in patients from the same cohort,

```{r PCA pathology, echo=FALSE}
ggplot2::ggplot(data = tmp, ggplot2::aes(x=PC1, y=PC2)) +
  geom_point(ggplot2::aes(color=study, shape=pat))

rm(xx,yy,zz,tmp, count.pca, df)
```


# Heatmap of count matrix

Then we built an heatmap based on the normalized count of the count matrix to check the clustering and similarity of the samples.

```{r Deseq object building for heatmap, warning=FALSE, include=FALSE}

check <- all(colnames(rawCount) == rownames(coldata))
if(check == FALSE){
  i <- intersect(rownames(coldata), colnames(rawCount))
  coldata <- coldata[i,]
  rawCount <- rawCount[,i]
}
all(colnames(rawCount) == rownames(coldata))

covars <- c("age_cat", "study", "sex")

m <- length(coldata[,last(covars)])
coldata <- tidyr::drop_na(coldata, last(covars))
n <- length(coldata[,last(covars)])
n.na <- m-n                                          # Ti dice quanti campioni ha eliminato

if(n.na>0){
  i <- intersect(colnames(rawCount), rownames(coldata)) # Risistema i dataframe in modo che siano uguali
  rawCount <- rawCount[,i]                              
  coldata <- coldata[i,]
  all.equal(colnames(rawCount), rownames(coldata))
}

model <- as.formula(paste("~", paste(covars,collapse = "+")))

rm(covar.path, count.path, i, m, n, check, covars, n.na)

dds <- DESeqDataSetFromMatrix(countData = rawCount,
                              colData = coldata,
                              design = model)

```

```{r heatmap1, echo=FALSE, fig.show="hold", message=FALSE, warning=FALSE}

vst <- varianceStabilizingTransformation(dds, blind=TRUE) # Transformation for data visualization

vst_mat <- assay(vst) # Extract the vst matrix from PCA

vst_cor <- cor(vst_mat) # Compute pairwise correlation values

breaksList = seq(0, 1, by = 0.1)

pheatmap(vst_cor,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)), 
         breaks = breaksList,
         fontsize_row = 5,
         fontsize_col = 5,
         main = "All samples",
         cutree_rows = 3,
         show_colnames = FALSE,
         show_rownames = FALSE)

xx <- which(coldata$id == "VOV114")
yy <- which(colnames(rawCount) == "VOV114")
coldata2 <- coldata[-xx,]
rawCount2 <- rawCount[,-yy]
dds2 <- DESeqDataSetFromMatrix(countData = rawCount2,
                               colData = coldata2,
                               design = model)

vst2 <- varianceStabilizingTransformation(dds2, blind=TRUE) # Transformation for data visualization

vst_mat2 <- assay(vst2) # Extract the vst matrix from PCA

vst_cor2 <- cor(vst_mat2)


pheatmap(vst_cor2,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
         breaks = breaksList,
         fontsize_row = 5,
         fontsize_col = 5,
         main = "Filtered",
         cutree_rows = 2,
         show_colnames = FALSE,
         show_rownames = FALSE)

rm(dds, dds2, vst, vst2, vst_cor, vst_cor2, vst_mat, vst_mat2, xx, yy, breaksList, coldata, rawCount, coldata2)

```

We removed VOV 114 from the downstream analyses because it clustered alone, showing too high differences in counts from the other samples.



# miRNA differential expression analyses. {.tabset .tabset-fade .tabset-pills}

We designed several models for DE analyses:

1 - Smoke: ~age + sex + library + smoke. Age and sex used as adjustment variables. Smoke was coded as non-smoker (0), ex-smoker (1) and smoker (2). 

2 – N. cigarettes/day : ~age + sex + library + N. cigarettes/day.  The smokers category was further stratified according to the number of cigarettes per day in light smoker (<16 cigarettes/day) and heavy smokers (>=16 cigarettes/day) 

3 - BMI: ~age + sex + bmi. Age and sex used as adjustment variables. BMI was coded as normal weight (0), underweight (1), overweight (2) and obese (3).

4 - Alcohol: ~age + sex + library + alcohol. Age and sex used as adjustment variables. Alcohol was coded according to gr/day of alcohol intake and categorized in abstemious (0 - 0 gr/day), mild drinker (0.1 – 18.5 gr/day), heavy drinker (>18.5 gr/day).

5 – Wine: ~age + sex + library + alcohol . Since the analyzed cohort is mainly composed by wine drinkers, miRNA expression levels were also investigated according to only wine consumption. The categories investigated were abstemious (0 - 0 gr/day), light drinker (12.50 gr/day) and heavy drinker (>12.50 gr/day)

6 - Physical activity: ~age + sex + library + phys_act. Physical activity was categorized using the EPIC guidelines. Total MET was calculated based on the different sources of physical activity selfreported on the questionnaires. Each patients was the assigned to one of four different group: inactive, moderately inactive, moderately active, active.

## Sex {.tabset}

```{r sex, warning=FALSE, include=FALSE}
count.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/ngs/merged_harmonized_converted.rds")
covar.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/clinical/merged_cleaned.rds")

rawCount <- readRDS(count.path)
coldata <- readRDS(covar.path)

rm <- which(coldata$id == "VOV114")
coldata <- coldata[-rm,]

covars <- c("library","age_cat","sex")

i <- intersect(colnames(rawCount), rownames(coldata)) # Controlla che i campioni siano gli stessi e ordinati nello stesso modo
rawCount <- rawCount[,i]                              # nella matrice delle conte e nella tabella delle covariate                          
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))

m <- length(coldata[,last(covars)])
coldata <- tidyr::drop_na(coldata, last(covars))
n <- length(coldata[,last(covars)])
n.na <- m-n # Ti dice quanti campioni ha eliminato

if(n.na>0){
i <- intersect(colnames(rawCount), rownames(coldata)) # Risistema i dataframe in modo che siano uguali
rawCount <- rawCount[,i]                              
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))
}

rm(covar.path,count.path,i,m,n)

model <- as.formula(paste("~", paste(covars,collapse = "+")))

dds <- DESeqDataSetFromMatrix(countData = rawCount,
                              colData = coldata,
                              design = model)
dds <- DESeq(dds)

res <- results(dds, contrast = c("sex","uomo", "donna"), alpha = 0.01)
res$miRNA <- rownames(res)
res <- as_tibble(res) %>% 
  dplyr::relocate("miRNA", .before = "baseMean") %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "M_F")
  
save(res, coldata, file = "C:/Users/amedeo/Desktop/R_Projects/stool/results/sex/sex.rda")

```

```{r summary sex, echo=FALSE}

n_res <- table(res$padj <0.05 & res$baseMean >15)
n_lfc_u <- table(res$log2FoldChange > 0 & res$padj <0.05 & res$baseMean >15)
n_lfc_d <- table(res$log2FoldChange < 0 & res$padj <0.05 & res$baseMean >15)

if(dim(n_res)>1){
  message("Male vs female: there are ", n_res[[2]], " differentially expressed miRNAs.")
  message("Log(2) fold change > 0: ", n_lfc_u[[2]])
  message("Log(2) fold change < 0: ", n_lfc_d[[2]])
  }else{
    message("Male vs female: there are no differentialy expressed miRNAs")
  }

```

```{r sex table, echo=FALSE}
kable(res) %>% kable_styling(bootstrap_options = c("striped", "hover"), position = "center") %>% scroll_box(height = "300px")
```

```{r sex volcano, echo=FALSE, message=FALSE, warning=FALSE}

# Volcano plot data #

df <- as_tibble(data.frame(miRNA = res$miRNA, baseMean = round(res$baseMean, digits = 2), logFC = round(res$log2FoldChange, digits = 2), negLogPval = -log10(res$pvalue), padj = round(res$padj, digits = 4)))
treshold <- df$padj <0.05 & df$baseMean >=15
df$treshold <- treshold
df$plot <- as.factor(df$treshold)
levels(df$plot) <- c("Non significative", "Significative [BaseMean > 15 ; padj <0.05]")
df <- df[complete.cases(df$plot),]

# Volcano plot 

plot_ly(df, x=~logFC, y=~negLogPval, type="scatter", mode = "markers", color=~plot, colors = c("#FF5733","#4FFF03"),
        hoverinfo = 'text',
        text = ~paste(miRNA, '\n Padj: ', padj, '\n Log2FC: ', logFC, '\n BaseMean', baseMean))

```

```{r sex boxplot, echo=FALSE, warning=FALSE}
# Boxplot data

sign_mir <- df %>% 
  dplyr::filter(baseMean >=15 & padj < 0.05)
sign_mir <- as.data.frame(sign_mir)
rownames(sign_mir) <- sign_mir$miRNA

countData <- rawCount[rownames(sign_mir),]
countData <- as.data.frame(t(countData))
countData <- countData[!seq_len(nrow(countData)) %in% sapply(countData, which.max),]
countData$id <- rownames(countData)
countData <- merge(countData, coldata, by= "id", all.x = TRUE)
countData <- dplyr::relocate(countData, "sex", .before = colnames(countData)[1])
countData <- dplyr::relocate(countData, "study", .after = colnames(countData)[1])

xx <- grepl(paste0("(?=.*", "hsa|sex|study", ")", collapse=""), colnames(countData), perl=TRUE)
countData <- countData[,xx]
countData <- countData[complete.cases(countData$sex),] # Droppo gli NA nella variabile di interesse

aa <- round((length(colnames(countData)) - 1)/3)
bb <- aa+aa
cc <- aa+((length(colnames(countData))) - aa)

idx <- which(colnames(countData) == "sex" | colnames(countData) == "study")
idx2 <- (aa+1):bb
idx3 <- (bb+1):cc

countData.aa <- countData[,c(1,2):aa]
countData.bb <- countData[,c(idx,idx2)]
countData.cc <- countData[,c(idx,idx3)]

countData.aa.m <- pivot_longer(countData.aa, c(3:length(colnames(countData.aa))), names_to = "miRNA", values_to = "count")
countData.bb.m <- pivot_longer(countData.bb, c(3:length(colnames(countData.bb))), names_to = "miRNA", values_to = "count")
countData.cc.m <- pivot_longer(countData.cc, c(3:length(colnames(countData.cc))), names_to = "miRNA", values_to = "count")

# Boxplot

ggplot(data = countData.aa.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=sex))+
       facet_wrap( ~ miRNA, scales="free") +
       scale_fill_discrete(name = "Sex", labels = c("Female", "Male"))

ggplot(data = countData.bb.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=sex))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "Sex", labels = c("Female", "Male"))

ggplot(data = countData.cc.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=sex))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "Sex", labels = c("Female", "Male"))

rm(list=ls())

```



## Age {.tabset}

```{r age, warning=FALSE, include=FALSE}
count.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/ngs/merged_harmonized_converted.rds")
covar.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/clinical/merged_cleaned.rds")

rawCount <- readRDS(count.path)
coldata <- readRDS(covar.path)

rm <- which(coldata$id == "VOV114")
coldata <- coldata[-rm,]

covars <- c("library","sex", "age_cat")

i <- intersect(colnames(rawCount), rownames(coldata)) # Controlla che i campioni siano gli stessi e ordinati nello stesso modo
rawCount <- rawCount[,i]                              # nella matrice delle conte e nella tabella delle covariate                          
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))

m <- length(coldata[,last(covars)])
coldata <- tidyr::drop_na(coldata, last(covars))
n <- length(coldata[,last(covars)])
n.na <- m-n                                          # Ti dice quanti campioni ha eliminato

if(n.na>0){
i <- intersect(colnames(rawCount), rownames(coldata)) # Risistema i dataframe in modo che siano uguali
rawCount <- rawCount[,i]                              
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))
}

rm(covar.path,count.path,i,m,n)

model <- as.formula(paste("~", paste(covars,collapse = "+")))

dds <- DESeqDataSetFromMatrix(countData = rawCount,
                              colData = coldata,
                              design = model)
dds <- DESeq(dds)

res_1 <- results(dds, contrast = c("age_cat","40_60", "_40"), alpha = 0.01)
res_1$miRNA <- rownames(res_1)
res_1 <- as_tibble(res_1) %>% 
  dplyr::relocate("miRNA", .before = "baseMean") %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "1_0")

res_2 <- results(dds, contrast = c("age_cat","60_", "_40"), alpha = 0.01)
res_2$miRNA <- rownames(res_2)
res_2 <- as_tibble(res_2) %>% 
  dplyr::relocate("miRNA", .before = "baseMean") %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "2_0")
  
res_3 <- results(dds, contrast = c("age_cat","60_", "40_60"), alpha = 0.01)
res_3$miRNA <- rownames(res_3)
res_3 <- as_tibble(res_3) %>% 
  dplyr::relocate("miRNA", .before = "baseMean") %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "2_1")

res <- bind_rows(res_1, res_2, res_3) %>% 
  dplyr::arrange(padj) %>% 
  dplyr::distinct(miRNA, .keep_all = TRUE)

save(res, res_1, res_2, res_3, file = "C:/Users/amedeo/Desktop/R_Projects/stool/results/age/age.rda")

```

```{r summary age, echo=FALSE}

n_res_1 <- table(res_1$padj <0.05 & res_1$baseMean >15)
n_lfc_u_1 <- table(res_1$log2FoldChange>0 &res_1$padj <0.05 & res_1$baseMean >15)
n_lfc_d_1 <- table(res_1$log2FoldChange<0 &res_1$padj <0.05 & res_1$baseMean >15)

n_res_2 <- table(res_2$padj <0.05 & res_2$baseMean >15)
n_lfc_u_2 <- table(res_2$log2FoldChange>0 &res_2$padj <0.05 & res_2$baseMean >15)
n_lfc_d_2 <- table(res_2$log2FoldChange<0 &res_2$padj <0.05 & res_2$baseMean >15)

n_res_3 <- table(res_3$padj <0.05 & res_3$baseMean >15)
n_lfc_u_3 <- table(res_3$log2FoldChange>0 &res_3$padj <0.05 & res_3$baseMean >15)
n_lfc_d_3 <- table(res_3$log2FoldChange<0 &res_3$padj <0.05 & res_3$baseMean >15)

if(dim(n_res_1)>1){
  message("40-60 vs <40: there are ", n_res_1[[2]], " differentially expressed miRNAs")
  message("Log(2) fold change > 0: ", n_lfc_u_1[[2]])
  message("Log(2) fold change < 0: ", n_lfc_d_1[[2]])
  }else{
    message("40-60 vs <40: there are no differentialy expressed miRNAs")
  }

if(dim(n_res_2)>1){
  message(">60 vs <40: there are ", n_res_2[[2]], " differentially expressed miRNAs")
  message("Log(2) fold change > 0: ", n_lfc_u_2[[2]])
  message("Log(2) fold change < 0: ", n_lfc_d_2[[2]])
  }else{
    message(">60 vs <40: there are no differentialy expressed miRNAs")
  }

if(dim(n_res_3)>1){
  message(">60 vs 40-60: there are ", n_res_3[[2]], " differentially expressed miRNAs")
  message("Log(2) fold change > 0: ", n_lfc_u_3[[2]])
  message("Log(2) fold change < 0: ", n_lfc_d_3[[2]])
  }else{
    message(">60 vs 40-60: there are no differentialy expressed miRNAs")
    }
```


```{r age table, echo=FALSE}
kable(res) %>% kable_styling(bootstrap_options = c("striped", "hover"), position = "center") %>% scroll_box(height = "300px")
```

```{r age volcano, echo=FALSE, message=FALSE, warning=FALSE}

# Volcano plot data #

df <- as_tibble(data.frame(miRNA = res$miRNA, baseMean = round(res$baseMean, digits = 2), logFC = round(res$log2FoldChange, digits = 2), negLogPval = -log10(res$pvalue), padj = round(res$padj, digits = 4)))
treshold <- df$padj <0.05 & df$baseMean >=15
df$treshold <- treshold
df$plot <- as.factor(df$treshold)
levels(df$plot) <- c("Non significative", "Significative [BaseMean > 15 ; padj <0.05]")
df <- df[complete.cases(df$plot),]

# Volcano plot 

plot_ly(df, x=~logFC, y=~negLogPval, type="scatter", mode = "markers", color=~plot, colors = c("#FF5733","#4FFF03"),
        hoverinfo = 'text',
        text = ~paste(miRNA, '\n Padj: ', padj, '\n Log2FC: ', logFC, '\n BaseMean', baseMean))
```

```{r age boxplot, echo=FALSE, warning=FALSE}
# Boxplot data

sign_mir <- df %>% 
  dplyr::filter(baseMean >=15 & padj < 0.05)
sign_mir <- as.data.frame(sign_mir)
rownames(sign_mir) <- sign_mir$miRNA

countData <- rawCount[rownames(sign_mir),]
countData <- as.data.frame(t(countData))
countData <- countData[!seq_len(nrow(countData)) %in% sapply(countData, which.max),]
countData$id <- rownames(countData)
countData <- merge(countData, coldata, by= "id", all.x = TRUE)
countData <- dplyr::relocate(countData, "age_cat", .before = colnames(countData)[1])
countData <- dplyr::relocate(countData, "study", .after = colnames(countData)[1])

xx <- grepl(paste0("(?=.*", "hsa|age_cat|study", ")", collapse=""), colnames(countData), perl=TRUE)
countData <- countData[,xx]
countData <- countData[complete.cases(countData$age_cat),] # Droppo gli NA nella variabile di interesse

aa <- round((length(colnames(countData)) - 1)/3)
bb <- aa+aa
cc <- aa+((length(colnames(countData))) - aa)

idx <- which(colnames(countData) == "age_cat" | colnames(countData) == "study")
idx2 <- (aa+1):bb
idx3 <- (bb+1):cc

countData.aa <- countData[,c(1,2):aa]
countData.bb <- countData[,c(idx,idx2)]
countData.cc <- countData[,c(idx,idx3)]

countData.aa.m <- pivot_longer(countData.aa, c(3:length(colnames(countData.aa))), names_to = "miRNA", values_to = "count")
countData.bb.m <- pivot_longer(countData.bb, c(3:length(colnames(countData.bb))), names_to = "miRNA", values_to = "count")
countData.cc.m <- pivot_longer(countData.cc, c(3:length(colnames(countData.cc))), names_to = "miRNA", values_to = "count")

# Boxplot

ggplot(data = countData.aa.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=age_cat))+
       facet_wrap( ~ miRNA, scales="free") +
       scale_fill_discrete(name = "Age", labels = c("<40 yrs", "40-60 yrs", ">60 yrs"))

ggplot(data = countData.bb.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=age_cat))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "Age", labels = c("<40 yrs", "40-60 yrs", ">60 yrs"))

ggplot(data = countData.cc.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=age_cat))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "Age", labels = c("<40 yrs", "40-60 yrs", ">60 yrs"))

rm(list=ls())

```



## Smoke {.tabset}

```{r smoke, warning=FALSE, include=FALSE}
count.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/ngs/merged_harmonized_converted.rds")
covar.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/clinical/merged_cleaned.rds")

rawCount <- readRDS(count.path)
coldata <- readRDS(covar.path)

covars <- c("age_cat","sex", "library", "smoke")

i <- intersect(colnames(rawCount), rownames(coldata)) # Controlla che i campioni siano gli stessi e ordinati nello stesso modo
rawCount <- rawCount[,i]                              # nella matrice delle conte e nella tabella delle covariate                          
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))

m <- length(coldata[,last(covars)])
coldata <- tidyr::drop_na(coldata, last(covars))
n <- length(coldata[,last(covars)])
n.na <- m-n                                          # Ti dice quanti campioni ha eliminato

if(n.na>0){
i <- intersect(colnames(rawCount), rownames(coldata)) # Risistema i dataframe in modo che siano uguali
rawCount <- rawCount[,i]                              
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))
}

rm(covar.path,count.path,i,m,n)

model <- as.formula(paste("~", paste(covars,collapse = "+")))

dds <- DESeqDataSetFromMatrix(countData = rawCount,
                              colData = coldata,
                              design = model)
dds <- DESeq(dds)

res_1 <- results(dds, contrast = c("smoke","ex_fumatore", "non_fumatore"), alpha = 0.01)
res_1$miRNA <- rownames(res_1)
res_1 <- as_tibble(res_1) %>% 
  dplyr::relocate("miRNA", .before = "baseMean") %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "1_0")

res_2 <- results(dds, contrast = c("smoke","fumatore", "non_fumatore"), alpha = 0.01)
res_2$miRNA <- rownames(res_2)
res_2 <- as_tibble(res_2) %>% 
  dplyr::relocate("miRNA", .before = "baseMean") %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "2_0")

res_3 <- results(dds, contrast = c("smoke","fumatore", "ex_fumatore"), alpha = 0.01)
res_3$miRNA <- rownames(res_3)
res_3 <- as_tibble(res_3) %>% 
  dplyr::relocate("miRNA", .before = "baseMean") %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "2_0")

res <- bind_rows(res_1, res_2, res_3) %>% 
  dplyr::arrange(padj) %>% 
  dplyr::distinct(miRNA, .keep_all = TRUE)

save(res, res_1, res_2, res_3, coldata, file = "C:/Users/amedeo/Desktop/R_Projects/stool/results/smoke/smoke.rda")
  

```

```{r summary smoke, echo=FALSE}

n_res_1 <- table(res_1$padj <0.05 & res_1$baseMean >15)
n_lfc_u_1 <- table(res_1$log2FoldChange>0 &res_1$padj <0.05 & res_1$baseMean >15)
n_lfc_d_1 <- table(res_1$log2FoldChange<0 &res_1$padj <0.05 & res_1$baseMean >15)

n_res_2 <- table(res_2$padj <0.05 & res_2$baseMean >15)
n_lfc_u_2 <- table(res_2$log2FoldChange>0 &res_2$padj <0.05 & res_2$baseMean >15)
n_lfc_d_2 <- table(res_2$log2FoldChange<0 &res_2$padj <0.05 & res_2$baseMean >15)

n_res_3 <- table(res_3$padj <0.05 & res_3$baseMean >15)
n_lfc_u_3 <- table(res_3$log2FoldChange>0 &res_3$padj <0.05 & res_3$baseMean >15)
n_lfc_d_3 <- table(res_3$log2FoldChange<0 &res_3$padj <0.05 & res_3$baseMean >15)

if(dim(n_res_1)>1){
  message("Former vs never: there are ", n_res_1[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u_1)>1){
    message("Log(2) fold change > 0: ", n_lfc_u_1[[2]])}
  if(dim(n_lfc_d_1)>1){
    message("Log(2) fold change < 0: ", n_lfc_d_1[[2]])
  }
if(dim(n_res_1)<1){
    message("Former vs never: there are no differentialy expressed miRNAs")
  }
}

if(dim(n_res_2)>1){
  message("Current vs never: there are ", n_res_2[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u_2)>1){
    message("Log(2) fold change > 0: ", n_lfc_u_2[[2]])}
  if(dim(n_lfc_d_2)>1){
    message("Log(2) fold change < 0: ", n_lfc_d_2[[2]])
  }
if(dim(n_res_2)<1){
    message("Current vs never: there are no differentialy expressed miRNAs")
  }
}

if(dim(n_res_3)>1){
  message("Current vs former: there are ", n_res_3[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u_3)>1){
    message("Log(2) fold change > 0: ", n_lfc_u_3[[2]])}
  if(dim(n_lfc_d_3)>1){
    message("Log(2) fold change < 0: ", n_lfc_d_3[[2]])
  }
if(dim(n_res_3)<1){
    message("Current vs former: there are no differentialy expressed miRNAs")
  }
}
```

```{r smoke table, echo=FALSE}
kable(res) %>% kable_styling(bootstrap_options = c("striped", "hover"), position = "center") %>% scroll_box(height = "300px")
```

```{r smoke volcano, echo=FALSE, message=FALSE, warning=FALSE}

# Volcano plot data #

df <- as_tibble(data.frame(miRNA = res$miRNA, baseMean = round(res$baseMean, digits = 2), logFC = round(res$log2FoldChange, digits = 2), negLogPval = -log10(res$pvalue), padj = round(res$padj, digits = 4)))
treshold <- df$padj <0.05 & df$baseMean >=15
df$treshold <- treshold
df$plot <- as.factor(df$treshold)
levels(df$plot) <- c("Non significative", "Significative [BaseMean > 15 ; padj <0.05]")
df <- df[complete.cases(df$plot),]

# Volcano plot 

plot_ly(df, x=~logFC, y=~negLogPval, type="scatter", mode = "markers", color=~plot, colors = c("#FF5733","#4FFF03"),
        hoverinfo = 'text',
        text = ~paste(miRNA, '\n Padj: ', padj, '\n Log2FC: ', logFC, '\n BaseMean', baseMean))

```

```{r smoke boxplot, echo=FALSE, warning=FALSE}
# Boxplot data

sign_mir <- df %>% 
  dplyr::filter(baseMean >=15 & padj < 0.05)
sign_mir <- as.data.frame(sign_mir)
rownames(sign_mir) <- sign_mir$miRNA

countData <- rawCount[rownames(sign_mir),]
countData <- as.data.frame(t(countData))
countData <- countData[!seq_len(nrow(countData)) %in% sapply(countData, which.max),]
countData$id <- rownames(countData)
countData <- merge(countData, coldata, by= "id", all.x = TRUE)
countData <- dplyr::relocate(countData, "study", .after = colnames(countData)[1])
countData <- dplyr::relocate(countData, "smoke", .before = colnames(countData)[1])

xx <- grepl(paste0("(?=.*", "hsa|smoke|study", ")", collapse=""), colnames(countData), perl=TRUE)
countData <- countData[,xx]
countData <- countData[complete.cases(countData$smoke),] # Droppo gli NA nella variabile di interesse
countData[,c("nev_father_smoke", "nev_mother_smoke", "nev_childhood_smoke_exp", "nev_partner_smoke", "nev_other_smoke", "nev_other_smoke_hours")] <- NULL

aa <- round((length(colnames(countData)) - 1)/3)
bb <- aa+aa
cc <- aa+((length(colnames(countData))) - aa)

idx <- which(colnames(countData) == "smoke" | colnames(countData) == "study")
idx2 <- (aa+1):bb
idx3 <- (bb+1):cc

countData.aa <- countData[,c(1,2):aa]
countData.bb <- countData[,c(idx,idx2)]
countData.cc <- countData[,c(idx,idx3)]

countData.aa.m <- pivot_longer(countData.aa, c(3:length(colnames(countData.aa))), names_to = "miRNA", values_to = "count")
countData.bb.m <- pivot_longer(countData.bb, c(3:length(colnames(countData.bb))), names_to = "miRNA", values_to = "count")
countData.cc.m <- pivot_longer(countData.cc, c(3:length(colnames(countData.cc))), names_to = "miRNA", values_to = "count")

# Boxplot

ggplot(data = countData.aa.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=smoke))+
       facet_wrap( ~ miRNA, scales="free") +
       scale_fill_discrete(name = "Smoke", labels = c("Never", "Former", "Current"))

ggplot(data = countData.bb.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=smoke))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "Smoke", labels = c("Never", "Former", "Current"))

ggplot(data = countData.cc.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=smoke))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "Smoke", labels = c("Never", "Former", "Current"))

rm(list=ls())

```



## Number of cigs {.tabset}

```{r ncigs, include=FALSE}
count.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/ngs/merged_harmonized_converted.rds")
covar.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/clinical/smoker.rds")

rawCount <- readRDS(count.path)
coldata <- readRDS(covar.path)

rm <- c("VOV114")
check <- rm %in% rownames(coldata)

if(check == TRUE){
  xx <- which(coldata$id == "VOV114")
  coldata <- coldata[-xx,]
}

covars <- c("age_cat","sex", "library", "curr_day_cat")

i <- intersect(colnames(rawCount), rownames(coldata)) # Controlla che i campioni siano gli stessi e ordinati nello stesso modo
rawCount <- rawCount[,i]                              # nella matrice delle conte e nella tabella delle covariate                          
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))

m <- length(coldata[,last(covars)])
coldata <- tidyr::drop_na(coldata, last(covars))
n <- length(coldata[,last(covars)])
n.na <- m-n                                          # Ti dice quanti campioni ha eliminato

if(n.na>0){
i <- intersect(colnames(rawCount), rownames(coldata)) # Risistema i dataframe in modo che siano uguali
rawCount <- rawCount[,i]                              
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))
}

rm(covar.path,count.path,i,m,n,check,n.na,rm)


model <- as.formula(paste("~", paste(covars,collapse = "+")))

dds <- DESeqDataSetFromMatrix(countData = rawCount,
                              colData = coldata,
                              design = model)
dds <- DESeq(dds)

res <- results(dds, contrast = c("curr_day_cat","1", "0"), alpha = 0.01)
res$miRNA <- rownames(res)
res <- as_tibble(res) %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "1_0") %>% 
  dplyr::relocate("miRNA", .before = "baseMean")

save(res, coldata, file="C:/Users/amedeo/Desktop/R_Projects/stool/results/ncigs/ncigs.rda")
```

```{r summary ncigs, echo=FALSE}

n_res <- table(res$padj <0.05 & res$baseMean >15)
n_lfc_u <- table(res$log2FoldChange>0 &res$padj <0.05 & res$baseMean >15)
n_lfc_d <- table(res$log2FoldChange<0 &res$padj <0.05 & res$baseMean >15)

if(dim(n_res)>1){
  message("Heavy smoker ( >16 cigs/day) vs light smoker ( <16 cigs/day): there are ", n_res[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u)>1){
    message("Log(2) fold change > 0: ", n_lfc_u[[2]])}
  if(dim(n_lfc_d)>1){
    message("Log(2) fold change < 0: ", n_lfc_d[[2]])
  }
if(dim(n_res)<1){
    message("Heavy smoker ( >16 cigs/day) vs light smoker ( <16 cigs/day): there are no differentialy expressed miRNAs")
  }
}

```

```{r cigs table, echo=FALSE}
kable(res) %>% kable_styling(bootstrap_options = c("striped", "hover"), position = "center") %>% scroll_box(height = "300px")
```

```{r cigs volcano, echo=FALSE, message=FALSE, warning=FALSE}

# Volcano plot data #

df <- as_tibble(data.frame(miRNA = res$miRNA, baseMean = round(res$baseMean, digits = 2), logFC = round(res$log2FoldChange, digits = 2), negLogPval = -log10(res$pvalue), padj = round(res$padj, digits = 4)))
treshold <- df$padj <0.05 & df$baseMean >=15
df$treshold <- treshold
df$plot <- as.factor(df$treshold)
levels(df$plot) <- c("Non significative", "Significative [BaseMean > 15 ; padj <0.05]")
df <- df[complete.cases(df$plot),]

# Volcano plot 

plot_ly(df, x=~logFC, y=~negLogPval, type="scatter", mode = "markers", color=~plot, colors = c("#FF5733","#4FFF03"),
        hoverinfo = 'text',
        text = ~paste(miRNA, '\n Padj: ', padj, '\n Log2FC: ', logFC, '\n BaseMean', baseMean))

```

```{r cigs boxplot, echo=FALSE, warning=FALSE}

# Boxplot data

sign_mir <- df %>% 
  dplyr::filter(baseMean >=15 & padj < 0.05)
sign_mir <- as.data.frame(sign_mir)
rownames(sign_mir) <- sign_mir$miRNA

countData <- rawCount[rownames(sign_mir),]
countData <- as.data.frame(t(countData))
countData <- countData[!seq_len(nrow(countData)) %in% sapply(countData, which.max),]
countData$id <- rownames(countData)
countData <- merge(countData, coldata, by= "id", all.x = TRUE)
countData <- dplyr::relocate(countData, "study", .after = colnames(countData)[1])
countData <- dplyr::relocate(countData, "curr_day_cat", .before = colnames(countData)[1])

xx <- grepl(paste0("(?=.*", "hsa|curr_day_cat|study", ")", collapse=""), colnames(countData), perl=TRUE)
countData <- countData[,xx]
countData <- countData[complete.cases(countData$curr_day_cat),] # Droppo gli NA nella variabile di interesse

aa <- round((length(colnames(countData)) - 1)/3)
bb <- aa+aa
cc <- aa+((length(colnames(countData))) - aa)

idx <- which(colnames(countData) == "curr_day_cat" | colnames(countData) == "study")
idx2 <- (aa+1):bb
idx3 <- (bb+1):cc

countData.aa <- countData[,c(1,2):aa]
countData.bb <- countData[,c(idx,idx2)]
countData.cc <- countData[,c(idx,idx3)]

countData.aa.m <- pivot_longer(countData.aa, c(3:length(colnames(countData.aa))), names_to = "miRNA", values_to = "count")
countData.bb.m <- pivot_longer(countData.bb, c(3:length(colnames(countData.bb))), names_to = "miRNA", values_to = "count")
countData.cc.m <- pivot_longer(countData.cc, c(3:length(colnames(countData.cc))), names_to = "miRNA", values_to = "count")

# Boxplot

ggplot(data = countData.aa.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=curr_day_cat))+
       facet_wrap( ~ miRNA, scales="free") +
       scale_fill_discrete(name = "N° cigs/day", labels = c("<16 cigs/day", ">16 cigs/day"))

ggplot(data = countData.bb.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=curr_day_cat))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "N° cigs/day", labels = c("<16 cigs/day", ">16 cigs/day"))

ggplot(data = countData.cc.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=curr_day_cat))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "N° cigs/day", labels = c("<16 cigs/day", ">16 cigs/day"))

rm(list=ls())


```



## BMI {.tabset}

In the analyses of DE miRNA using BMI as the variable of interest we decide to group together overweight and obese samples due to the little sample size of the groups if considered alone. Underweight samples are not considered for now, so the only comparison is between BMI > 25 and normal BMI samples.

```{r bmi, include=FALSE}
count.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/ngs/merged_harmonized_converted.rds")
covar.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/clinical/merged_cleaned.rds")

rawCount <- readRDS(count.path)
coldata <- readRDS(covar.path)

rm <- c("VOV114")
check <- rm %in% rownames(coldata)

if(check == TRUE){
  xx <- which(coldata$id == "VOV114")
  coldata <- coldata[-xx,]
}

levels(coldata$bmi_cat) <- c("1","0","2","2") ## solo per analisi bmi
coldata <- coldata[which(coldata$bmi_cat != "1"),]

i <- intersect(colnames(rawCount), rownames(coldata)) # Controlla che i campioni siano gli stessi e ordinati nello stesso modo
rawCount <- rawCount[,i]                              # nella matrice delle conte e nella tabella delle covariate                          
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))

covars <- c("age_cat","sex", "library", "bmi_cat")

m <- length(coldata[,last(covars)])
coldata <- tidyr::drop_na(coldata, last(covars))
n <- length(coldata[,last(covars)])
n.na <- m-n                                          # Ti dice quanti campioni ha eliminato

if(n.na>0){
i <- intersect(colnames(rawCount), rownames(coldata)) # Risistema i dataframe in modo che siano uguali
rawCount <- rawCount[,i]                              
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))
}

rm(covar.path,count.path,i,m,n,check, rm, n.na, xx)

model <- as.formula(paste("~", paste(covars,collapse = "+")))

dds <- DESeqDataSetFromMatrix(countData = rawCount,
                              colData = coldata,
                              design = model)
dds <- DESeq(dds)

res <- results(dds, contrast = c("bmi_cat","2", "0"), alpha = 0.01)
res$miRNA <- rownames(res)
res <- as_tibble(res) %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "2_0") %>% 
  dplyr::relocate("miRNA", .before = "baseMean")

save(res, coldata, file="C:/Users/amedeo/Desktop/R_Projects/stool/results/bmi/bmi.rda")
```

```{r summary bmi, echo=FALSE}

n_res <- table(res$padj <0.05 & res$baseMean >15)
n_lfc_u <- table(res$log2FoldChange>0 &res$padj <0.05 & res$baseMean >15)
n_lfc_d <- table(res$log2FoldChange<0 &res$padj <0.05 & res$baseMean >15)

if(dim(n_res)>1){
  message("Normal vs overweight: there are ", n_res[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u)>1){
    message("Log(2) fold change > 0: ", n_lfc_u[[2]])}
  if(dim(n_lfc_d)>1){
    message("Log(2) fold change < 0: ", n_lfc_d[[2]])
  }
if(dim(n_res)<1){
    message("Normal vs overweight: there are no differentialy expressed miRNAs")
  }
}

```

```{r bmi table, echo=FALSE}
kable(res) %>% kable_styling(bootstrap_options = c("striped", "hover"), position = "center") %>% scroll_box(height = "300px")
```

```{r bmi volcano, echo=FALSE, message=FALSE, warning=FALSE}

# Volcano plot data #

df <- as_tibble(data.frame(miRNA = res$miRNA, baseMean = round(res$baseMean, digits = 2), logFC = round(res$log2FoldChange, digits = 2), negLogPval = -log10(res$pvalue), padj = round(res$padj, digits = 4)))
treshold <- df$padj <0.05 & df$baseMean >=15
df$treshold <- treshold
df$plot <- as.factor(df$treshold)
levels(df$plot) <- c("Non significative", "Significative [BaseMean > 15 ; padj <0.05]")
df <- df[complete.cases(df$plot),]

# Volcano plot 

plot_ly(df, x=~logFC, y=~negLogPval, type="scatter", mode = "markers", color=~plot, colors = c("#FF5733","#4FFF03"),
        hoverinfo = 'text',
        text = ~paste(miRNA, '\n Padj: ', padj, '\n Log2FC: ', logFC, '\n BaseMean', baseMean))

```

```{r bmi boxplot}
# Boxplot data

sign_mir <- df %>% 
  dplyr::filter(baseMean >=15 & padj < 0.05)
sign_mir <- as.data.frame(sign_mir)
rownames(sign_mir) <- sign_mir$miRNA

countData <- rawCount[rownames(sign_mir),]
countData <- as.data.frame(t(countData))
countData <- countData[!seq_len(nrow(countData)) %in% sapply(countData, which.max),]
countData$id <- rownames(countData)
countData <- merge(countData, coldata, by= "id", all.x = TRUE)
countData <- dplyr::relocate(countData, "study", .after = colnames(countData)[1])
countData <- dplyr::relocate(countData, "bmi_cat", .before = colnames(countData)[1])

xx <- grepl(paste0("(?=.*", "hsa|bmi_cat|study", ")", collapse=""), colnames(countData), perl=TRUE)
countData <- countData[,xx]
countData <- countData[complete.cases(countData$bmi_cat),]# Droppo gli NA nella variabile di interesse
countData$bmi <- NULL
  
aa <- round((length(colnames(countData)) - 1)/3)
bb <- aa+aa
cc <- aa+((length(colnames(countData))) - aa)

idx <- which(colnames(countData) == "bmi_cat" | colnames(countData) == "study")
idx2 <- (aa+1):bb
idx3 <- (bb+1):cc

countData.aa <- countData[,c(1,2):aa]
countData.bb <- countData[,c(idx,idx2)]
countData.cc <- countData[,c(idx,idx3)]

countData.aa.m <- pivot_longer(countData.aa, c(3:length(colnames(countData.aa))), names_to = "miRNA", values_to = "count")
countData.bb.m <- pivot_longer(countData.bb, c(3:length(colnames(countData.bb))), names_to = "miRNA", values_to = "count")
countData.cc.m <- pivot_longer(countData.cc, c(3:length(colnames(countData.cc))), names_to = "miRNA", values_to = "count")

# Boxplot

ggplot(data = countData.aa.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=bmi_cat))+
       facet_wrap( ~ miRNA, scales="free") +
       scale_fill_discrete(name = "BMI", labels = c("Normal", "Overweight"))

ggplot(data = countData.bb.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=bmi_cat))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "BMI", labels = c("Normal", "Overweight"))

ggplot(data = countData.cc.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=bmi_cat))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "BMI", labels = c("Normal", "Overweight"))

rm(list=ls())


```


## Alcohol consumption {.tabset}

```{r alcohol, include=FALSE}
count.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/ngs/merged_harmonized_converted.rds")
covar.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/clinical/merged_cleaned.rds")

rawCount <- readRDS(count.path)
coldata <- readRDS(covar.path)

rm <- c("VOV114")
check <- rm %in% rownames(coldata)
if(check == TRUE){
  xx <- which(coldata$id == "VOV114")
  coldata <- coldata[-xx,]
}

covars <- c("age_cat","sex", "library", "alcool")

i <- intersect(colnames(rawCount), rownames(coldata)) # Controlla che i campioni siano gli stessi e ordinati nello stesso modo
rawCount <- rawCount[,i]                              # nella matrice delle conte e nella tabella delle covariate                          
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))

m <- length(coldata[,last(covars)])
coldata <- tidyr::drop_na(coldata, last(covars))
n <- length(coldata[,last(covars)])
n.na <- m-n                                          # Ti dice quanti campioni ha eliminato

if(n.na>0){
i <- intersect(colnames(rawCount), rownames(coldata)) # Risistema i dataframe in modo che siano uguali
rawCount <- rawCount[,i]                              
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))
}

rm(covar.path,count.path,i,m,n,check, rm, n.na, xx)

model <- as.formula(paste("~", paste(covars,collapse = "+")))

dds <- DESeqDataSetFromMatrix(countData = rawCount,
                              colData = coldata,
                              design = model)
dds <- DESeq(dds)

res_1 <- results(dds, contrast = c("alcool","1", "0"), alpha = 0.01)
res_1$miRNA <- rownames(res_1)
res_1 <- as_tibble(res_1) %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "1_0") %>% 
  dplyr::relocate("miRNA", .before = "baseMean")

res_2 <- results(dds, contrast = c("alcool","2", "0"), alpha = 0.01)
res_2$miRNA <- rownames(res_2)
res_2 <- as_tibble(res_2) %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "2_0") %>% 
  dplyr::relocate("miRNA", .before = "baseMean")

res_3 <- results(dds, contrast = c("alcool","2", "1"), alpha = 0.01)
res_3$miRNA <- rownames(res_3)
res_3 <- as_tibble(res_3) %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "2_1") %>% 
  dplyr::relocate("miRNA", .before = "baseMean")

res <- bind_rows(res_1, res_2, res_3) %>% 
  dplyr::arrange(padj) %>% 
  distinct(miRNA, .keep_all = TRUE )

save(res, res_1, res_2, res_3, coldata, file="C:/Users/amedeo/Desktop/R_Projects/stool/results/alcohol/alcohol.rda")

```

```{r summary alcohol, echo=FALSE}

n_res_1 <- table(res_1$padj <0.05 & res_1$baseMean >15)
n_lfc_u_1 <- table(res_1$log2FoldChange>0 &res_1$padj <0.05 & res_1$baseMean >15)
n_lfc_d_1 <- table(res_1$log2FoldChange<0 &res_1$padj <0.05 & res_1$baseMean >15)

n_res_2 <- table(res_2$padj <0.05 & res_2$baseMean >15)
n_lfc_u_2 <- table(res_2$log2FoldChange>0 &res_2$padj <0.05 & res_2$baseMean >15)
n_lfc_d_2 <- table(res_2$log2FoldChange<0 &res_2$padj <0.05 & res_2$baseMean >15)

n_res_3 <- table(res_3$padj <0.05 & res_3$baseMean >15)
n_lfc_u_3 <- table(res_3$log2FoldChange>0 &res_3$padj <0.05 & res_3$baseMean >15)
n_lfc_d_3 <- table(res_3$log2FoldChange<0 &res_3$padj <0.05 & res_3$baseMean >15)

if(dim(n_res_1)>1){
  message("Light drinker vs abstemious: there are ", n_res_1[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u_1)>1){
    message("Log(2) fold change > 0: ", n_lfc_u_1[[2]])}
  if(dim(n_lfc_d_1)>1){
    message("Log(2) fold change < 0: ", n_lfc_d_1[[2]])
  }
if(dim(n_res_1)<1){
    message("Light drinker [0.1-18.5 gr/day] vs abstemious: there are no differentialy expressed miRNAs")
  }
}

if(dim(n_res_2)==2){
  message("Heavy drinker [>18.5 gr/day] vs abstemious: there are ", n_res_2[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u_2)>1){
    message("Log(2) fold change > 0: ", n_lfc_u_2[[2]])}
  if(dim(n_lfc_d_2)>1){
    message("Log(2) fold change < 0: ", n_lfc_d_2[[2]])
  }
}
if(dim(n_res_2)==1){
    message("Heavy drinker [>18.5 gr/day] vs abstemious: there are no differentialy expressed miRNAs")
  }


if(dim(n_res_3)>1){
  message("Heavy drinker [>18.5 gr/day] vs light drinker [0.1-18.5 gr/day]: there are ", n_res_3[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u_3)>1){
    message("Log(2) fold change > 0: ", n_lfc_u_3[[2]])}
  if(dim(n_lfc_d_3)>1){
    message("Log(2) fold change < 0: ", n_lfc_d_3[[2]])
  }}
if(dim(n_res_3)==1){
    message("Heavy drinker [>18.5 gr/day] vs abstemious: there are no differentialy expressed miRNAs")
  }
```

```{r alcohol table, echo=FALSE}
kable(res) %>% kable_styling(bootstrap_options = c("striped", "hover"), position = "center") %>% scroll_box(height = "300px")
```

```{r alcohol volcano, echo=FALSE, message=FALSE, warning=FALSE}

# Volcano plot data #

df <- as_tibble(data.frame(miRNA = res$miRNA, baseMean = round(res$baseMean, digits = 2), logFC = round(res$log2FoldChange, digits = 2), negLogPval = -log10(res$pvalue), padj = round(res$padj, digits = 4)))
treshold <- df$padj <0.05 & df$baseMean >=15
df$treshold <- treshold
df$plot <- as.factor(df$treshold)
levels(df$plot) <- c("Non significative", "Significative [BaseMean > 15 ; padj <0.05]")
df <- df[complete.cases(df$plot),]

# Volcano plot 

plot_ly(df, x=~logFC, y=~negLogPval, type="scatter", mode = "markers", color=~plot, colors = c("#FF5733","#4FFF03"),
        hoverinfo = 'text',
        text = ~paste(miRNA, '\n Padj: ', padj, '\n Log2FC: ', logFC, '\n BaseMean', baseMean))

```

```{r alcohol boxplot, echo=FALSE, warning=FALSE}
# Boxplot data

sign_mir <- df %>% 
  dplyr::filter(baseMean >=15 & padj < 0.05)
sign_mir <- as.data.frame(sign_mir)
rownames(sign_mir) <- sign_mir$miRNA

countData <- rawCount[rownames(sign_mir),]
countData <- as.data.frame(t(countData))
countData <- countData[!seq_len(nrow(countData)) %in% sapply(countData, which.max),]
countData$id <- rownames(countData)
countData <- merge(countData, coldata, by= "id", all.x = TRUE)
countData <- dplyr::relocate(countData, "alcool", .before = colnames(countData)[1])
countData <- dplyr::relocate(countData, "study", .before = colnames(countData)[1])
xx <- grepl(paste0("(?=.*", "hsa|alcool|study", ")", collapse=""), colnames(countData), perl=TRUE)

countData <- countData[,xx]
countData$TOT.alcool_g.day <- NULL

countData.m <- pivot_longer(countData, c(3:length(colnames(countData))), names_to = "miRNA", values_to = "count")

# Boxplot

ggplot(data = countData.m, aes(x=study, y=log2(count))) + 
  geom_boxplot(aes(fill=alcool))+
  facet_wrap( ~ miRNA, scales="free")+
  scale_fill_discrete(name = "Alcohol consumption", labels = c("Abstemious", "Mild drinker [0.1-18.5 gr/day]", "Heavy drinker [>18.5 gr/day"))

rm(list=ls())


```

## Wine consumption {.tabset}

```{r wine, include=FALSE}
count.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/ngs/merged_harmonized_converted.rds")
covar.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/clinical/merged_cleaned.rds")

rawCount <- readRDS(count.path)
coldata <- readRDS(covar.path)

rm <- c("VOV114")
check <- rm %in% rownames(coldata)
if(check == TRUE){
  xx <- which(coldata$id == "VOV114")
  coldata <- coldata[-xx,]
}

keep <- which(coldata$alco_class != 0)
coldata <- coldata[keep,]

covars <- c("age_cat","sex", "library", "alco_class")

i <- intersect(colnames(rawCount), rownames(coldata)) # Controlla che i campioni siano gli stessi e ordinati nello stesso modo
rawCount <- rawCount[,i]                              # nella matrice delle conte e nella tabella delle covariate                          
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))

m <- length(coldata[,last(covars)])
coldata <- tidyr::drop_na(coldata, last(covars))
n <- length(coldata[,last(covars)])
n.na <- m-n                                          # Ti dice quanti campioni ha eliminato

if(n.na>0){
  i <- intersect(colnames(rawCount), rownames(coldata)) # Risistema i dataframe in modo che siano uguali
  rawCount <- rawCount[,i]                              
  coldata <- coldata[i,]
  all.equal(colnames(rawCount), rownames(coldata))
}

rm(covar.path,count.path,i,m,n,check, rm, n.na, xx)

model <- as.formula(paste("~", paste(covars,collapse = "+")))

dds <- DESeqDataSetFromMatrix(countData = rawCount,
                              colData = coldata,
                              design = model)
dds <- DESeq(dds)

res <- results(dds, contrast = c("alco_class","2", "1"), alpha = 0.01)
res$miRNA <- rownames(res)
res <- as_tibble(res) %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "1_0") %>% 
  dplyr::relocate("miRNA", .before = "baseMean")

save(res, coldata, file="C:/Users/amedeo/Desktop/R_Projects/stool/results/wine/wine.rda")

```

```{r summary wine, echo=FALSE}

n_res <- table(res$padj <0.05 & res$baseMean >15)
n_lfc_u <- table(res$log2FoldChange>0 &res$padj <0.05 & res$baseMean >15)
n_lfc_d <- table(res$log2FoldChange<0 &res$padj <0.05 & res$baseMean >15)

if(dim(n_res)>1){
  message("No wine consumption vs every alcohol: there are ", n_res[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u)>1){
    message("Log(2) fold change > 0: ", n_lfc_u[[2]])}
  if(dim(n_lfc_d)>1){
    message("Log(2) fold change < 0: ", n_lfc_d[[2]])
  }
if(dim(n_res)<1){
    message("No wine consumption vs every alcohol: there are no differentialy expressed miRNAs")
  }
}

```

```{r wine table, echo=FALSE}
kable(res) %>% kable_styling(bootstrap_options = c("striped", "hover"), position = "center") %>% scroll_box(height = "300px")
```

```{r wine volcano, warning=FALSE}

# Volcano plot data #

df <- as_tibble(data.frame(miRNA = res$miRNA, baseMean = round(res$baseMean, digits = 2), logFC = round(res$log2FoldChange, digits = 2), negLogPval = -log10(res$pvalue), padj = round(res$padj, digits = 4)))
treshold <- df$padj <0.05 & df$baseMean >=15
df$treshold <- treshold
df$plot <- as.factor(df$treshold)
levels(df$plot) <- c("Non significative", "Significative [BaseMean > 15 ; padj <0.05]")
df <- df[complete.cases(df$plot),]

# Volcano plot 

plot_ly(df, x=~logFC, y=~negLogPval, type="scatter", mode = "markers", color=~plot, colors = c("#FF5733","#4FFF03"),
        hoverinfo = 'text',
        text = ~paste(miRNA, '\n Padj: ', padj, '\n Log2FC: ', logFC, '\n BaseMean', baseMean))


```

```{r wine boxplot, echo=FALSE, warning=FALSE}
# Boxplot data

sign_mir <- df %>% 
  dplyr::filter(baseMean >=15 & padj < 0.05)
sign_mir <- as.data.frame(sign_mir)
rownames(sign_mir) <- sign_mir$miRNA

countData <- rawCount[rownames(sign_mir),]
countData <- as.data.frame(t(countData))
countData <- countData[!seq_len(nrow(countData)) %in% sapply(countData, which.max),]
countData$id <- rownames(countData)
countData <- merge(countData, coldata, by= "id", all.x = TRUE)
countData <- dplyr::relocate(countData, "study", .after = colnames(countData)[1])
countData <- dplyr::relocate(countData, "alco_class", .before = colnames(countData)[1])

xx <- grepl(paste0("(?=.*", "hsa|alco_class|study", ")", collapse=""), colnames(countData), perl=TRUE)
countData <- countData[,xx]
countData <- countData[complete.cases(countData$alco_class),]# Droppo gli NA nella variabile di interesse

aa <- round((length(colnames(countData)) - 1)/3)
bb <- aa+aa
cc <- aa+((length(colnames(countData))) - aa)

idx <- which(colnames(countData) == "alco_class" | colnames(countData) == "study")
idx2 <- (aa+1):bb
idx3 <- (bb+1):cc

countData.aa <- countData[,c(1,2):aa]
countData.bb <- countData[,c(idx,idx2)]
countData.cc <- countData[,c(idx,idx3)]

countData.aa.m <- pivot_longer(countData.aa, c(3:length(colnames(countData.aa))), names_to = "miRNA", values_to = "count")
countData.bb.m <- pivot_longer(countData.bb, c(3:length(colnames(countData.bb))), names_to = "miRNA", values_to = "count")
countData.cc.m <- pivot_longer(countData.cc, c(3:length(colnames(countData.cc))), names_to = "miRNA", values_to = "count")

# Boxplot

ggplot(data = countData.aa.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=alco_class))+
       facet_wrap( ~ miRNA, scales="free") +
       scale_fill_discrete(name = "Wine consumption", labels = c("All types of alcohol", "No wine"))

ggplot(data = countData.bb.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=alco_class))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "Wine consumption", labels = c("All types of alcohol", "No wine"))

ggplot(data = countData.cc.m, aes(x=study, y=log2(count))) + 
       geom_boxplot(aes(fill=alco_class))+
       facet_wrap( ~ miRNA, scales="free")+
       scale_fill_discrete(name = "Wine consumption", labels = c("All types of alcohol", "No wine"))

rm(list=ls())

```

## Physical activity {.tabset}

```{r phys_act, include=FALSE}
count.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/ngs/merged_harmonized_converted.rds")
covar.path <- c("C:/Users/amedeo/Desktop/R_projects/stool/data_redo/clinical/merged_cleaned.rds")

rawCount <- readRDS(count.path)
coldata <- readRDS(covar.path)

rm <- c("VOV114")
check <- rm %in% rownames(coldata)
if(check == TRUE){
  xx <- which(coldata$id == "VOV114")
  coldata <- coldata[-xx,]
}

covars <- c("age_cat","sex", "library", "phys_act")

i <- intersect(colnames(rawCount), rownames(coldata)) # Controlla che i campioni siano gli stessi e ordinati nello stesso modo
rawCount <- rawCount[,i]                              # nella matrice delle conte e nella tabella delle covariate                          
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))

m <- length(coldata[,last(covars)])
coldata <- tidyr::drop_na(coldata, last(covars))
n <- length(coldata[,last(covars)])
n.na <- m-n                                          # Ti dice quanti campioni ha eliminato

if(n.na>0){
i <- intersect(colnames(rawCount), rownames(coldata)) # Risistema i dataframe in modo che siano uguali
rawCount <- rawCount[,i]                              
coldata <- coldata[i,]
all.equal(colnames(rawCount), rownames(coldata))
}

rm(covar.path,count.path,i,m,n,check, rm, n.na, xx)

model <- as.formula(paste("~", paste(covars,collapse = "+")))

dds <- DESeqDataSetFromMatrix(countData = rawCount,
                              colData = coldata,
                              design = model)
dds <- DESeq(dds)

res_1 <- results(dds, contrast = c("phys_act","1", "0"), alpha = 0.01)
res_1$miRNA <- rownames(res_1)
res_1 <- as_tibble(res_1) %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "1_0") %>% 
  dplyr::relocate("miRNA", .before = "baseMean")

res_2 <- results(dds, contrast = c("phys_act","2", "0"), alpha = 0.01)
res_2$miRNA <- rownames(res_2)
res_2 <- as_tibble(res_2) %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "2_0") %>% 
  dplyr::relocate("miRNA", .before = "baseMean")

res_3 <- results(dds, contrast = c("phys_act","2", "1"), alpha = 0.01)
res_3$miRNA <- rownames(res_3)
res_3 <- as_tibble(res_3) %>% 
  dplyr::arrange(padj) %>% 
  dplyr::mutate(comparison = "2_1") %>% 
  dplyr::relocate("miRNA", .before = "baseMean")

res <- bind_rows(res_1, res_2, res_3) %>% 
  dplyr::arrange(padj) %>% 
  distinct(miRNA, .keep_all = TRUE )

save(res, res_1, res_2, res_3, coldata, file = "C:/Users/amedeo/Desktop/R_Projects/stool/results/pshysical/phys_act.rda")

```

```{r summary phys_act, echo=FALSE}

n_res_1 <- table(res_1$padj <0.05 & res_1$baseMean >15)
n_lfc_u_1 <- table(res_1$log2FoldChange>0 &res_1$padj <0.05 & res_1$baseMean >15)
n_lfc_d_1 <- table(res_1$log2FoldChange<0 &res_1$padj <0.05 & res_1$baseMean >15)

n_res_2 <- table(res_2$padj <0.05 & res_2$baseMean >15)
n_lfc_u_2 <- table(res_2$log2FoldChange>0 &res_2$padj <0.05 & res_2$baseMean >15)
n_lfc_d_2 <- table(res_2$log2FoldChange<0 &res_2$padj <0.05 & res_2$baseMean >15)

n_res_3 <- table(res_3$padj <0.05 & res_3$baseMean >15)
n_lfc_u_3 <- table(res_3$log2FoldChange>0 &res_3$padj <0.05 & res_3$baseMean >15)
n_lfc_d_3 <- table(res_3$log2FoldChange<0 &res_3$padj <0.05 & res_3$baseMean >15)

if(dim(n_res_1)>1){
  message("Moderately inactive vs active: there are ", n_res_1[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u_1)>1){
    message("Log(2) fold change > 0: ", n_lfc_u_1[[2]])}
  if(dim(n_lfc_d_1)>1){
    message("Log(2) fold change < 0: ", n_lfc_d_1[[2]])
  }}
if(dim(n_res_1)==1){
    message("Moderately inactive vs active: there are no differentialy expressed miRNAs")
  }


if(dim(n_res_2)>1){
  message("Inactive vs active: there are ", n_res_2[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u_2)>1){
    message("Log(2) fold change > 0: ", n_lfc_u_2[[2]])}
  if(dim(n_lfc_d_2)>1){
    message("Log(2) fold change < 0: ", n_lfc_d_2[[2]])
  }
}
if(dim(n_res_2)==1){
    message("Inactive vs active: there are no differentialy expressed miRNAs")
  }


if(dim(n_res_3)>1){
  message("Inactive vs moderately inactive: there are ", n_res_3[[2]], " differentially expressed miRNAs")
  if(dim(n_lfc_u_3)>1){
    message("Log(2) fold change > 0: ", n_lfc_u_3[[2]])}
  if(dim(n_lfc_d_3)>1){
    message("Log(2) fold change < 0: ", n_lfc_d_3[[2]])
  }}
if(dim(n_res_3)==1){
    message("Inactive vs moderately inactive: there are no differentialy expressed miRNAs")
  }
```

```{r phys_act table, echo=FALSE}
kable(res) %>% kable_styling(bootstrap_options = c("striped", "hover"), position = "center") %>% scroll_box(height = "300px")
```

```{r phys_act volcano, echo=FALSE, message=FALSE, warning=FALSE}

df <- as_tibble(data.frame(miRNA = res$miRNA, baseMean = round(res$baseMean, digits = 2), logFC = round(res$log2FoldChange, digits = 2), negLogPval = -log10(res$pvalue), padj = round(res$padj, digits = 4)))
treshold <- df$padj <0.05 & df$baseMean >=15
df$treshold <- treshold
df$plot <- as.factor(df$treshold)
levels(df$plot) <- c("Non significative", "Significative [BaseMean > 15 ; padj <0.05]")
df <- df[complete.cases(df$plot),]

# Volcano plot 

plot_ly(df, x=~logFC, y=~negLogPval, type="scatter", mode = "markers", color=~plot, colors = c("#FF5733","#4FFF03"),
        hoverinfo = 'text',
        text = ~paste(miRNA, '\n Padj: ', padj, '\n Log2FC: ', logFC, '\n BaseMean', baseMean))

```

```{r phys_act boxplot, echo=FALSE, warning=FALSE}
# Boxplot data

sign_mir <- df %>% 
  dplyr::filter(baseMean >=15 & padj < 0.05)
sign_mir <- as.data.frame(sign_mir)
rownames(sign_mir) <- sign_mir$miRNA

countData <- rawCount[rownames(sign_mir),]
countData <- as.data.frame(t(countData))
countData <- countData[!seq_len(nrow(countData)) %in% sapply(countData, which.max),]
countData$id <- rownames(countData)
countData <- merge(countData, coldata, by= "id", all.x = TRUE)
countData <- dplyr::relocate(countData, "phys_act", .before = colnames(countData)[1])
countData <- dplyr::relocate(countData, "study", .before = colnames(countData)[1])
xx <- grepl(paste0("(?=.*", "hsa|phys_act|study", ")", collapse=""), colnames(countData), perl=TRUE)

countData <- countData[,xx]
countData$TOT.alcool_g.day <- NULL

countData.m <- pivot_longer(countData, c(3:length(colnames(countData))), names_to = "miRNA", values_to = "count")

# Boxplot

ggplot(data = countData.m, aes(x=study, y=log2(count))) + 
  geom_boxplot(aes(fill=phys_act))+
  facet_wrap( ~ miRNA, scales="free")+
  scale_fill_discrete(name = "Physical activity", labels = c("Active", "Moderately inactive", "Inactive"))

rm(list=ls())


```

## Upset plot

The following upset plot reports the intersection of DEmiRNAs across the analysis.

```{r upset plot, echo=FALSE, warning=FALSE}

# Data load

load("C:/Users/amedeo/Desktop/R_Projects/stool/results/age/age.rda")
age <- res
rm(res, res_1, res_2, res_3)

load("C:/Users/amedeo/Desktop/R_Projects/stool/results/sex/sex.rda")
sex <- res
rm(res)

load("C:/Users/amedeo/Desktop/R_Projects/stool/results/smoke/smoke.rda")
smoke <- res
rm(res, res_1, res_2)

load("C:/Users/amedeo/Desktop/R_Projects/stool/results/alcohol/alcohol.rda")
alcohol <- res
rm(res, res_1, res_2, res_3)

load("C:/Users/amedeo/Desktop/R_Projects/stool/results/bmi/bmi.rda")
bmi <- res
rm(res)

load("C:/Users/amedeo/Desktop/R_Projects/stool/results/ncigs/ncigs.rda")
cigs <- res
rm(res)

load("C:/Users/amedeo/Desktop/R_Projects/stool/results/wine/wine.rda")
wine <- res
rm(res, res_1, res_2, res_3)

load("C:/Users/amedeo/Desktop/R_Projects/stool/results/pshysical/phys_act.rda")
phys_act <- res

rm(res, res_1, res_2, res_3, coldata)

# VENN

age <- age[which(age$baseMean >= 15 & age$padj <0.05),]
age <- age$miRNA 

sex <- sex[which(sex$baseMean >= 15 & sex$padj <0.05),]
sex <- sex$miRNA 

alc <- alcohol[which(alcohol$baseMean >= 15 & alcohol$padj <0.05),]
alc <- alc$miRNA 

bmi <- bmi[which(bmi$baseMean >= 15 & bmi$padj <0.05),]
bmi <- bmi$miRNA 

cigs <- cigs[which(cigs$baseMean >= 15 & cigs$padj <0.05),]
cigs <- cigs$miRNA

smoke <- smoke[which(smoke$baseMean >= 15 & smoke$padj <0.05),]
smoke <- smoke$miRNA

wine <- wine[which(wine$baseMean >= 15 & wine$padj <0.05),]
wine <- wine$miRNA

phys <- phys_act[which(phys_act$baseMean >= 15 & phys_act$padj <0.05),]
phys <- phys$miRNA

## UPSET

lt <- list(set1 = age,
           set2 = sex,
           set3 = smoke,
           set4 = bmi,
           set5 = cigs,
           set6 = alc,
           set8 = wine,
           set7 = phys)

m <- make_comb_mat(lt, mode = "intersect")
m <- m[comb_degree(m) > 1]
ss <- set_size(m)
cs <- comb_size(m)
set_name(m) <- c("Age", "Sex", "Smoke", "BMI", "Ncigs", "Alcohol", "Wine", "Physical")

ht <- UpSet(m,
            set_order = order(ss),
            comb_order = order(comb_degree(m), -cs),
            top_annotation = HeatmapAnnotation(
              "miRNAs intersections" = anno_barplot(cs,
                      ylim = c(0, max(cs)*1.1),
                      border = FALSE, 
                      gp = gpar(fill = "black"), 
                      height = unit(10, "cm")
              ),
              annotation_name_side = "left", 
              annotation_name_rot = 90),
            left_annotation = rowAnnotation(
              "#miRNAs in each set" = anno_barplot(-ss, 
                      baseline = 0,
                      axis_param = list(
                      at = c(0, -10, -15, -20, -25, -30, -35, -40, -45),
                      labels = c(0, 10, 15, 20, 25, 30, 35, 40, 45),
                      labels_rot = 0),
                      border = FALSE, 
                      gp = gpar(fill = "black"), 
                      width = unit(4, "cm")
              ),
              set_name = anno_text(set_name(m), 
                      location = 0.5, 
                      just = "center",
                      width = max_text_width(set_name(m)) + unit(4, "mm"))
            ), 
            right_annotation = NULL,
            show_row_names = FALSE)

ht = draw(ht)
od = column_order(ht)

ComplexHeatmap::decorate_annotation("miRNAs intersections", {
  grid.text(cs[od], x = seq_along(cs), y = unit(cs[od], "native") + unit(2, "pt"), 
            default.units = "native", just = c("left", "bottom"), 
            gp = gpar(fontsize = 6, col = "#404040"), rot = 45)
})
            

```

